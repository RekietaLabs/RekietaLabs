<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RekietaLabs Receipt</title>
  <style>
    body {
      background-color: #222;
      color: white;
      font-family: monospace;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #be9f13;
    }
    .receipt {
      background-color: #333;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      margin: auto;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    button {
      margin-top: 15px;
      background-color: #be9f13;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    .disclaimer {
      font-size: 0.8rem;
      margin-top: 20px;
      color: #bbb;
    }
  </style>
</head>
<body>
  <h1>RekietaLabs Receipt</h1>
  <div class="receipt" id="receiptDisplay">Loading receipt...</div>

  <script>
    const cashierMap = {
      "8836": "Brandi",
      "4646": "Justin",
      "7423": "Kellan"
    };

    function formatCurrency(value) {
      return "$" + Number(value).toFixed(2);
    }

    function generateReceiptHTML(data) {
      const itemsHTML = data.order.map(item => `<li>${item.name} - ${formatCurrency(item.price)}</li>`).join("");

      const taxRate = 0.0825;
      const tax = (parseFloat(data.total) * taxRate).toFixed(2);
      const totalWithTax = (parseFloat(data.total) + parseFloat(tax)).toFixed(2);
      const cashierName = cashierMap[data.cashierPin] || "Unknown";

      return `
        <p><strong>Order #: </strong>${data.orderNumber}</p>
        <p><strong>Cashier: </strong>${cashierName}</p>
        <p><strong>Terminal: </strong>${data.terminal}</p>
        <ul>${itemsHTML}</ul>
        <p><strong>Subtotal:</strong> ${formatCurrency(data.total)}</p>
        <p><strong>Tax (8.25%):</strong> ${formatCurrency(tax)}</p>
        <p><strong>Total:</strong> ${formatCurrency(totalWithTax)}</p>
        <button onclick="downloadReceipt()">Download Receipt</button>
        <p class="disclaimer">All sales final. Returns allowed within 30 days with receipt. Please retain this receipt for your records.</p>
      `;
    }

    function downloadReceipt() {
      const text = document.getElementById("receiptDisplay").innerText;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "RekietaLabs_Receipt.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get("ordernumber");

    if (orderNumber) {
      const saleKey = `sale_${orderNumber}`;
      const saleData = JSON.parse(localStorage.getItem(saleKey));
      if (saleData && Date.now() < saleData.expiresAt + (30 * 24 * 60 * 60 * 1000)) { // 30 day validity
        document.getElementById("receiptDisplay").innerHTML = generateReceiptHTML(saleData);
      } else {
        document.getElementById("receiptDisplay").innerHTML = "<p>Receipt not found or has expired.</p>";
      }
    } else {
      document.getElementById("receiptDisplay").innerHTML = "<p>Invalid receipt link.</p>";
    }
  </script>
</body>
</html>
